[![Tests](https://github.com/RikudouSage/DynamoDbCachePsr6Bundle/workflows/Tests/badge.svg)](https://github.com/RikudouSage/DynamoDbCachePsr6Bundle/actions?query=workflow%3ATests)

Don't use Symfony? Use the [standalone library](https://github.com/RikudouSage/DynamoDbCachePsr6).

## Installation

`composer require rikudou/psr6-dynamo-db-bundle`

## Configuration

Create the file `config/packages/dynamo_db_cache.yaml` and put at least the table name there:

```yaml
rikudou_dynamo_db_cache:
    table: myCacheTableName
```

Everything else has default values, though you probably want to also configure the dynamo db client.

### Configuration options:

- `replace_default_adapter` - set to `true` to replace the default `AdapterInterface` implementation with the adapter
from this bundle (default: **false**)
- `table` - the table which will be used for storing the cache (**required**)
- `client_service` - The service that will be used as DynamoDB client, if not set this bundle will try to create one
(more details in `client_config` option below) but the use is limited
- `client_config` - If no `client_service` is configured, it will be created from the values of this config. It contains
two subkeys:
    - `region` - the AWS region (default: **us-east-1**)
    - `version` - the service version (default: **latest**)
    - no other options are available, if you need to configure more, please create and assign custom `client_service`
- `primary_key_field` - the name of the field that will be used as the primary key (default: **id**)
- `ttl_field` - the name of the field that will be used as the ttl field (default: **ttl**)
- `value_field` - the name of the field that will be used as the value field (default: **value**)

Autogenerated default config (via `bin/console config:dump rikudou_dynamo_db_cache`):

```yaml
# Default configuration for extension with alias: "rikudou_dynamo_db_cache"
rikudou_dynamo_db_cache:

    # Replace default cache adapter with this one
    replace_default_adapter: false

    # The DynamoDB table to use as cache
    table:                null

    # The service to use as the Dynamo DB client
    client_service:       null

    # The Dynamo DB client configuration. If you need finer tuning, create the service yourself and assign it in client_service
    client_config:

        # The AWS region
        region:               us-east-1

        # The service version
        version:              latest

    # The field to be used as primary key
    primary_key_field:    id

    # The field to be used as ttl
    ttl_field:            ttl

    # The field to be used as value
    value_field:          value
```

## Usage

You can use one of the two available services:

- `Rikudou\DynamoDbCache\DynamoDbCache` - this one doesn't implement the Symfony `AdapterInterface`
- `Rikudou\DynamoDbCacheBundle\Cache\DynamoDbCacheAdapter` - this one implements the Symfony `AdapterInterface`

If you set the `replace_default_adapter` to `true` you can also use the
`Symfony\Component\Cache\Adapter\AdapterInterface` service.

### Example

```php
<?php

use Rikudou\DynamoDbCacheBundle\Cache\DynamoDbCacheAdapter;
use Rikudou\DynamoDbCache\DynamoDbCache;

class MyService
{
    public function __construct(DynamoDbCache $cache, DynamoDbCacheAdapter $adapter)
    {
        // it doesn't matter whether you use the adapter or not, the usage is the same, the
        // only difference is that adapter implements the Symfony interface and thus you can
        // use it to replace the default AdapterInterface implementation
        $item = $cache->getItem('test');
        $item2 = $cache->getItem('test');
    
        $item->set('some value');
        $adapter->save($item);
    }
}
```

While using the `replace_default_adapter` option:

```php
<?php

use Symfony\Component\Cache\Adapter\AdapterInterface;

class MyService
{
    public function __construct(AdapterInterface $cache)
    {
        $item = $cache->getItem('test');
        // do stuff with cache item
        $cache->save($item);
    }
}
```

## Converters

This bundle supports all instances of `\Psr\Cache\CacheItemInterface` with the use of converters which
convert the object to `\Rikudou\DynamoDbCache\DynamoCacheItem`. Note that some information may be lost in the
conversion, notably expiration date.

This bundle has a handler for the default Symfony `\Symfony\Component\Cache\CacheItem` where it retains also the
information about expiration date.

If you use any other `CacheItemInterface` implementation, you may need to write your custom handler:

```php
<?php

use Rikudou\DynamoDbCache\Converter\CacheItemConverterInterface;
use Psr\Cache\CacheItemInterface;
use Rikudou\DynamoDbCache\DynamoCacheItem;

class MyCacheItemConverter implements CacheItemConverterInterface
{
    /**
     * If this methods returns true, the converter will be used
     */
    public function supports(CacheItemInterface $cacheItem): bool
    {
        return $cacheItem instanceof MyCacheItem;
    }
    
    public function convert(CacheItemInterface $cacheItem): DynamoCacheItem
    {
        assert($cacheItem instanceof MyCacheItem);
        return new DynamoCacheItem(
            $cacheItem->getKey(),
            $cacheItem->isHit(),
            $cacheItem->get(),
            $cacheItem->getExpirationDate() // this is a custom method from the hypothetical MyCacheItem
        );
    }
}
```

Your converter is now automatically registered in the converter system and will be used whenever you try to save
an instance of `MyCacheItem`.

> If you don't use autoconfiguration, tag your service with `rikudou.dynamo_cache.converter`

The default converter which will be used as last option can convert all `CacheItemInterface` objects but has no
way to get the expiration date since the interface doesn't provide such information.
